#!/bin/bash

source .venv/bin/activate

# --- CONFIGURATION ---
# Static list of USDT futures base coins from MEXC
PAIRS=(
    # "0G"
    # "1000000BABYDOGE"
    # "1000000MOG"
    # "1000BONK"
    # "1000BTT"
    # "1000RATS"
    # "114514"
    # "1INCH"
    # "2Z"
    # "4"
    # "42"
    # "A"
    # "A2Z"
    # "AAVE"
    # "ACE"
    # "ACH"
    # "ACS"
    # "ACT"
    # "ACX"
    # "ADA"
    # "AERGO"
    # "AERO"
    # "AEVO"
    # "AGI"
    # "AGLD"
    # "AGT"
    # "AI"
    # "AIAV"
    # "AIN"
    # "AIO"
    # "AIOT"
    # "AIOZ"
    # "AIXBT"
    # "AKE"
    # "AKT"
    # "ALCH"
    # "ALEO"
    # "ALGO"
    # "ALICE"
    # "ALL"
    # "ALLO"
    # "ALMANAK"
    # "ALPINE"
    # "ALT"
    # "ALU"
    # "AMP"
    # "ANIME"
    # "ANKR"
    # "APE"
    # "APEX"
    # "API3"
    # "APR"
    # "APT"
    # "AR"
    # "ARB"
    # "ARCSOL"
    # "ARIA"
    # "ARK"
    # "ARKM"
    # "ARPA"
    # "ARTX"
    # "ASP"
    # "ASR"
    # "ASTER"
    # "ASTR"
    # "AT"
    # "ATA"
    # "ATH"
    # "ATOM"
    # "AUCTION"
    # "AUDIO"
    # "AVA"
    # "AVAAI"
    # "AVAX"
    # "AVICI"
    # "AVL"
    # "AVNT"
    # "AWE"
    # "AXL"
    # "AXS"
    # "B"
    # "B2"
    # "B3"
    # "BABY"
    # "BAN"
    # "BANANA"
    # "BANANAS31"
    # "BAND"
    # "BANK"
    # "BAR"
    # "BARD"
    # "BAS"
    # "BAT"
    # "BAY"
    # "BB"
    # "BCH"
    # "BDX"
    # "BDXN"
    # "BEAMX"
    # "BEAT"
    # "BEL"
    # "BERA"
    # "BEST"
    # "BIANRENSHENG"
    # "BICO"
    # "BID"
    # "BIGTIME"
    # "BIO"
    # "BLAST"
    # "BLESS"
    # "BLOCK"
    # "BLUAI"
    # "BLUR"
    # "BMT"
    # "BNB"
    # "BNT"
    # "BOBA"
    # "BOME"
    # "BR"
    # "BRETT"
    # "BREV"
    # "BROCCOLI"
    # "BROCCOLIF3B"
    # "BSU"
    # "BSV"
    # "BTC"
    # "BTR"
    # "BTX"
    # "BUILDONBOB"
    # "BULLA"
    # "BYTE"
    # "C"
    # "C98"
    # "CAKE"
    # "CAMP"
    # "CARV"
    # "CAT"
    # "CATI"
    # "CC"
    # "CELO"
    # "CELR"
    # "CETUS"
    # "CFX"
    # "CGN"
    # "CGPT"
    # "CHEEMS"
    # "CHESS"
    # "CHILLGUY"
    # "CHR"
    # "CHZ"
    # "CITY"
    # "CKB"
    # "CLANKER"
    # "CLO"
    # "CLOUD"
    # "COAI"
    # "COLLECT"
    # "COMMON"
    # "COMP"
    # "COOK"
    # "COOKIE"
    # "CORE"
    # "COS"
    # "COTI"
    # "COW"
    # "CRO"
    # "CROSS"
    # "CRV"
    # "CSPR"
    # "CTC"
    # "CTK"
    # "CTSI"
    # "CUDIS"
    # "CVC"
    # "CVX"
    # "CYBER"
    # "CYPR"
    # "CYS"
    "D"
    "DAM"
    "DASH"
    "DBR"
    "DEEP"
    "DEGEN"
    "DEGO"
    "DENT"
    "DF"
    "DGB"
    "DGRAM"
    "DIA"
    "DIGI"
    "DMC"
    "DN"
    "DODO"
    "DOG"
    "DOGE"
    "DOGS"
    "DOLO"
    "DOOD"
    "DOT"
    "DRIFT"
    "DSYNC"
    "DUSK"
    "DYDX"
    "DYM"
    "EAT"
    "EDEN"
    "EDU"
    "EGLD"
    "EIGEN"
    "ELIZAOS"
    "ELON"
    "ELX"
    "ENA"
    "ENJ"
    "ENS"
    "ENSO"
    "EPH"
    "EPIC"
    "EPT"
    "ERA"
    "ES"
    "ESIM"
    "ESPORTS"
    "ETC"
    "ETH"
    "ETHFI"
    "ETHW"
    "EUL"
    "EVAA"
    "F"
    "FARM"
    "FARTCOIN"
    "FET"
    "FF"
    "FHE"
    "FIDA"
    "FILECOIN"
    "FIO"
    "FIS"
    "FLOCK"
    "FLOKI"
    "FLOW"
    "FLR"
    "FLUID"
    "FLUX"
    "FOLKS"
    "FORM"
    "FORT"
    "FORTH"
    "FRANKLIN"
    "FTT"
    "FUN"
    "FWOG"
    "G"
    "GAIB"
    "GAIX"
    "GALA"
    "GAS"
    "GHST"
    "GIGA"
    "GIGGLE"
    "GLM"
    "GMT"
    "GMX"
    "GNO"
    "GOAT"
    "GODS"
    "GPS"
    "GRASS"
    "GRIFFAIN"
    "GRT"
    "GTC"
    "GUA"
    "GUN"
    "H"
    "HAEDAL"
    "HANA"
    "HARRY"
    "HBAR"
    "HEI"
    "HEMI"
    "HFT"
    "HIGH"
    "HIPPO"
    "HIVE"
    "HMSTR"
    "HNT"
    "HOLO"
    "HOME"
    "HOOK"
    "HOT"
    "HUMA"
    "HYPE"
    "HYPER"
    "ICNT"
    "ICP"
    "ICX"
    "ID"
    "IDEX"
    "IDOL"
    "IKA"
    "ILV"
    "IMX"
    "IN"
    "INIT"
    "INJ"
    "IO"
    "IOST"
    "IOTA"
    "IOTX"
    "IP"
    "IQ"
    "IR"
    "IRYS"
    "JASMY"
    "JCT"
    "JELLYJELLY"
    "JOE"
    "JST"
    "JTO"
    "JUP"
    "KAIA"
    "KAITO"
    "KAS"
    "KAVA"
    "KERNEL"
    "KGEN"
    "KITE"
    "KMNO"
    "KNC"
    "KO"
    "KOMA"
    "KSM"
    "L3"
    "LA"
    "LAB"
    "LAVA"
    "LAYER"
    "LAZIO"
    "LDO"
    "LIGHT"
    "LINEA"
    "LINK"
    "LISA"
    "LISTA"
    "LIT"
    "LMWR"
    "LONG"
    "LPT"
    "LQTY"
    "LRC"
    "LSK"
    "LTC"
    "LUMIA"
    "LUNANEW"
    "LUNC"
    "LYN"
    "M"
    "MAGIC"
    "MAGMA"
    "MAIGA"
    "MAMO"
    "MANA"
    "MANTA"
    "MANYU"
    "MASK"
    "MAV"
    "MAVIA"
    "MBOX"
    "ME"
    "MEGA"
    "MELANIA"
    "MEME"
    "MERL"
    "MET"
    "METIS"
    "MEW"
    "MILK"
    "MINA"
    "MIRA"
    "MITO"
    "MLN"
    "MMT"
    "MNT"
    "MOCA"
    "MONAD"
    "MOODENG"
    "MORI"
    "MORPHO"
    "MOVE"
    "MOVR"
    "MTL"
    "MUBARAK"
    "MYX"
    "NAORIS"
    "NB"
    "NEAR"
    "NEIROCTO"
    "NEO"
    "NEWT"
    "NFP"
    "NIGHT"
    "NIL"
    "NKN"
    "NMR"
    "NOBODY"
    "NOM"
    "NOT"
    "NPC"
    "NS"
    "NTRN"
    "NUMI"
    "NVIDIA"
    "NXPC"
    "OBOL"
    "OBT"
    "OG"
    "OGN"
    "OKB"
    "OL"
    "OM"
    "ON"
    "ONDO"
    "ONE"
    "ONG"
    "ONT"
    "OOOO"
    "OP"
    "OPENLEDGER"
    "ORBS"
    "ORCA"
    "ORDER"
    "ORDI"
    "ORE"
    "OXT"
    "PARTI"
    "PAXG"
    "PEAQ"
    "PENDLE"
    "PENGU"
    "PEOPLE"
    "PEPE"
    "PHA"
    "PHB"
    "PI"
    "PIEVERSE"
    "PING"
    "PIPE"
    "PIPPIN"
    "PIXEL"
    "PLANCK"
    "PLAY"
    "PLUME"
    "PNUT"
    "POL"
    "POLYX"
    "POND"
    "PONKE"
    "POPCAT"
    "PORTAL"
    "POWER"
    "POWR"
    "PROM"
    "PROMPT"
    "PROVE"
    "PTB"
    "PUFFER"
    "PUMPBTC"
    "PUMPFUN"
    "PUNDIX"
    "PYBOBO"
    "PYR"
    "PYTH"
    "Q"
    "QKC"
    "QNT"
    "QTUM"
    "QUBIC"
    "RACA"
    "RARE"
    "RAVE"
    "RAY"
    "RBNT"
    "RDNT"
    "RECALL"
    "RED"
    "REI"
    "RENDER"
    "REPPO"
    "REQ"
    "RESOLV"
    "REZ"
    "RIF"
    "RIVER"
    "RLC"
    "RLS"
    "ROAM"
    "RON"
    "ROSE"
    "RPL"
    "RSR"
    "RUNE"
    "RUSSELL"
    "RVN"
    "RVV"
    "S"
    "SAFE"
    "SAGA"
    "SAHARA"
    "SAND"
    "SANTOS"
    "SAPIEN"
    "SAROS"
    "SATS"
    "SC"
    "SCR"
    "SCRT"
    "SD"
    "SEEK"
    "SEI"
    "SENT"
    "SENTIS"
    "SFP"
    "SHELL"
    "SHIB"
    "SIGN"
    "SILVER"
    "SIREN"
    "SKATE"
    "SKL"
    "SKY"
    "SKYAI"
    "SLP"
    "SNT"
    "SNX"
    "SOL"
    "SOLV"
    "SOMI"
    "SONIC"
    "SOONNETWORK"
    "SOPH"
    "SPELL"
    "SPK"
    "SPX"
    "SQD"
    "SSV"
    "STABLE"
    "STBL"
    "STEEM"
    "STG"
    "STO"
    "STORJ"
    "STRAX"
    "STRK"
    "STX"
    "SUI"
    "SUN"
    "SUPRA"
    "SUSHI"
    "SWARMS"
    "SXP"
    "SXT"
    "SYN"
    "SYRUP"
    "SYS"
    "T"
    "TA"
    "TAC"
    "TAG"
    "TAI"
    "TAIKO"
    "TAKE"
    "TANSSI"
    "TAO"
    "TEL"
    "TFUEL"
    "THE"
    "THETA"
    "THQ"
    "TIA"
    "TLM"
    "TNSR"
    "TOKEN"
    "TONCOIN"
    "TOSHI"
    "TOWNS"
    "TRAC"
    "TRADOOR"
    "TRB"
    "TREE"
    "TRU"
    "TRUMPOFFICIAL"
    "TRUST"
    "TRUTH"
    "TRX"
    "TRY"
    "TST"
    "TTD"
    "TURBO"
    "TURTLE"
    "TUT"
    "TWT"
    "TYCOON"
    "U"
    "UAI"
    "UB"
    "ULTIMA"
    "UMA"
    "UNI"
    "US"
    "USELESS"
    "USTC"
    "USUAL"
    "VANA"
    "VANRY"
    "VELO"
    "VELODROME"
    "VELVET"
    "VET"
    "VFY"
    "VIC"
    "VINE"
    "VIRTUAL"
    "VOOI"
    "VOXEL"
    "VTHO"
    "VVV"
    "W"
    "WAL"
    "WAVES"
    "WAXP"
    "WCT"
    "WET"
    "WHITEWHALE"
    "WIF"
    "WIN"
    "WLD"
    "WLFI"
    "WMTX"
    "WOO"
    "WOTAMALAILE"
    "X"
    "XAI"
    "XAN"
    "XAUT"
    "XCH"
    "XCN"
    "XDC"
    "XEC"
    "XION"
    "XLM"
    "XMR"
    "XNO"
    "XNY"
    "XPIN"
    "XPL"
    "XRP"
    "XTZ"
    "XVG"
    "XVS"
    "YALA"
    "YB"
    "YEE"
    "YFI"
    "YGG"
    "YZY"
    "ZAMA"
    "ZBCN"
    "ZBT"
    "ZEC"
    "ZEN"
    "ZEREBRO"
    "ZETA"
    "ZEUS"
    "ZIG"
    "ZIL"
    "ZKC"
    "ZKJ"
    "ZKP"
    "ZKSYNC"
    "ZORA"
    "ZRC"
    "ZRO"
    "ZRX"
    "ZTC"
)
echo "Processing ${#PAIRS[@]} USDT pairs."

# Define the directory where the result logs will be saved.
OUTPUT_DIR="out"
RESULTS_DIR="${OUTPUT_DIR}/results"
PROGRESS_DIR="${OUTPUT_DIR}/progress"

# --- SCRIPT LOGIC ---
echo "ðŸš€ Starting backtesting research for all cryptos..."

# Create the output directories if they don't exist.
mkdir -p "$RESULTS_DIR"
mkdir -p "$PROGRESS_DIR"
echo "Results will be saved in '$RESULTS_DIR'"
echo "Progress logs will be saved in '$PROGRESS_DIR'"
echo "--------------------------------------------------"

# Loop through each pair in the array.
COUNTER=0
TOTAL=${#PAIRS[@]}
START_TIME=$(date +%s)

for crypto_currency in "${PAIRS[@]}"; do
    COUNTER=$((COUNTER + 1))

    # Calculate estimated time remaining
    if [ $COUNTER -gt 1 ]; then
        CURRENT_TIME=$(date +%s)
        ELAPSED_TOTAL=$((CURRENT_TIME - START_TIME))
        PROCESSED=$((COUNTER - 1))

        # Calculate average time per item (integer division)
        if [ $PROCESSED -gt 0 ]; then
            AVG_TIME=$((ELAPSED_TOTAL / PROCESSED))
        else
            AVG_TIME=0
        fi

        ITEMS_LEFT=$((TOTAL - PROCESSED))
        EST_SECONDS_LEFT=$((AVG_TIME * ITEMS_LEFT))

        # Format time
        H=$((EST_SECONDS_LEFT / 3600))
        M=$(( (EST_SECONDS_LEFT % 3600) / 60 ))
        S=$((EST_SECONDS_LEFT % 60))

        TIME_MSG=" | Est. remaining: ${H}h ${M}m ${S}s"
    else
        TIME_MSG=" | Est. remaining: Calculating..."
    fi

    echo "[${COUNTER}/${TOTAL}] Processing crypto: ${crypto_currency}${TIME_MSG}"

    # 2. Prepare the log file names.
    filename_symbol=$(echo "$crypto_currency" | sed 's/\//_/g')
    log_file="${RESULTS_DIR}/${filename_symbol}_research.log"
    progress_file="${PROGRESS_DIR}/${filename_symbol}_progress.log"

    echo "   -> Running research... Log file: ${log_file}, Error file: ${progress_file}"

    # 3. Execute the 'research' command, passing the exchange.
    #    Redirect stdout to log_file and stderr to progress_file.
    cli research --currency="$crypto_currency" "$@" > "$log_file" 2> "$progress_file"

    echo "âœ… Finished research for ${crypto_currency}."
    echo "--------------------------------------------------"
done

echo "ðŸŽ‰ All backtesting research is complete."
